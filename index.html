<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>勤怠管理</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      color: #1e293b;
      /* iPad ズーム機能を無効化 */
      touch-action: manipulation;
      -webkit-text-size-adjust: 100%;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    .logo {
      margin-bottom: 40px;
      opacity: 0;
      animation: fadeInDown 0.6s ease-out 0.1s forwards;
    }

    .logo img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: 
        0 20px 40px rgba(0,0,0,0.1),
        0 8px 16px rgba(0,0,0,0.06),
        0 0 0 1px rgba(255,255,255,0.9);
      border: 2px solid rgba(255, 255, 255, 0.8);
      transition: all 0.4s ease;
    }

    .logo img:hover {
      transform: scale(1.02) translateY(-2px);
      box-shadow: 
        0 25px 50px rgba(0,0,0,0.15),
        0 12px 20px rgba(0,0,0,0.08),
        0 0 0 1px rgba(255,255,255,0.9);
    }

    .container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      border-radius: 24px;
      padding: 48px;
      width: 100%;
      max-width: 420px;
      box-shadow: 
        0 25px 50px rgba(0, 0, 0, 0.05),
        0 10px 25px rgba(0, 0, 0, 0.03),
        0 0 0 1px rgba(255, 255, 255, 0.3);
      opacity: 0;
      animation: fadeInUp 0.8s ease-out 0.2s forwards;
      position: relative;
      /* ズーム防止設定 */
      touch-action: manipulation;
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.8), transparent);
      border-radius: 24px 24px 0 0;
    }

    h1 {
      text-align: center;
      font-size: 1.875em;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 48px;
      letter-spacing: -0.025em;
      background: linear-gradient(135deg, #1e293b 0%, #475569 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .clock {
      text-align: center;
      margin-bottom: 40px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: 
        0 8px 25px rgba(0, 0, 0, 0.03),
        0 3px 10px rgba(0, 0, 0, 0.02),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }

    .clock-date {
      font-size: 1.1em;
      font-weight: 500;
      color: #64748b;
      margin-bottom: 8px;
      letter-spacing: 0.02em;
    }

    .clock-time {
      font-size: 2.2em;
      font-weight: 300;
      color: #1e293b;
      font-variant-numeric: tabular-nums;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, #1e293b 0%, #3b82f6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .form-group {
      margin-bottom: 24px;
      position: relative;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #424245;
      font-size: 0.9em;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .input-wrapper {
      position: relative;
    }

    input[type="text"] {
      width: 100%;
      padding: 18px 24px;
      font-size: 1em;
      border: 1px solid rgba(226, 232, 240, 0.8);
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      outline: none;
      color: #1e293b;
      min-height: 44px;
      -webkit-appearance: none;
      -webkit-tap-highlight-color: transparent;
      box-shadow: 
        0 4px 12px rgba(0, 0, 0, 0.02),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
      /* 入力フィールドではテキスト選択を有効にする */
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
      touch-action: manipulation;
    }

    input[type="text"]:focus {
      border-color: #3b82f6;
      box-shadow: 
        0 0 0 3px rgba(59, 130, 246, 0.1),
        0 8px 24px rgba(0, 0, 0, 0.04),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
      background: rgba(255, 255, 255, 0.95);
      transform: translateY(-1px);
    }

    input[type="text"]::placeholder {
      color: #8e8e93;
    }

    /* 名前フィールドの右パディングを調整（クリアボタン用のスペース確保） */
    #empName {
      padding-right: 48px;
    }

    /* 検索フィールドの右パディングを調整（クリアボタン用のスペース確保） */
    #searchEmpName {
      padding-right: 48px;
    }

    /* クリアボタンのスタイル */
    .clear-btn {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 28px;
      height: 28px;
      border: none;
      background: rgba(142, 142, 147, 0.15);
      color: #8e8e93;
      border-radius: 50%;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: none; /* 初期状態は非表示 */
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      z-index: 10;
      /* ズーム防止設定 */
      touch-action: manipulation;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      line-height: 1;
    }

    .clear-btn:hover {
      background: rgba(142, 142, 147, 0.25);
      color: #666;
      transform: translateY(-50%) scale(1.05);
    }

    .clear-btn:active {
      background: rgba(142, 142, 147, 0.35);
      transform: translateY(-50%) scale(0.95);
    }

    .clear-btn.show {
      display: flex;
      animation: fadeInScale 0.2s ease-out;
    }

    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: translateY(-50%) scale(0.8);
      }
      to {
        opacity: 1;
        transform: translateY(-50%) scale(1);
      }
    }

    /* ドロップダウンメニューのスタイル */
    .dropdown-menu {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.6);
      border-radius: 16px;
      box-shadow: 
        0 20px 40px rgba(0, 0, 0, 0.1),
        0 8px 20px rgba(0, 0, 0, 0.06),
        0 0 0 1px rgba(255, 255, 255, 0.4);
      z-index: 1000;
      max-height: 280px;
      overflow-x: hidden; /* 横スクロール無効 */
      overflow-y: auto; /* 縦スクロールのみ有効 */
      display: none;
      margin-top: 4px;
      animation: slideDown 0.3s ease-out;
      /* 縦スクロールバーのみ薄く表示 */
      scrollbar-width: thin; /* Firefox */
      scrollbar-color: rgba(0, 0, 0, 0.2) transparent; /* Firefox */
    }

    /* WebKit系ブラウザの縦スクロールバーのみ */
    .dropdown-menu::-webkit-scrollbar {
      width: 6px; /* 縦スクロールバーの幅 */
      height: 0; /* 横スクロールバーを完全に無効 */
    }

    .dropdown-menu::-webkit-scrollbar-track {
      background: transparent;
    }

    .dropdown-menu::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 3px;
    }

    .dropdown-menu::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.3);
    }

    /* 横スクロールバーを完全に無効化 */
    .dropdown-menu::-webkit-scrollbar:horizontal {
      display: none;
    }

    .dropdown-menu.show {
      display: block;
    }

    .dropdown-item {
      padding: 16px 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #1e293b;
      font-size: 1em;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      justify-content: space-between;
      min-height: 56px; /* タッチフレンドリーな高さ */
    }

    .dropdown-item:last-child {
      border-bottom: none;
    }

    .dropdown-item:hover {
      background: rgba(59, 130, 246, 0.08);
      color: #3b82f6;
      transform: translateX(4px);
    }

    .dropdown-item:first-child {
      border-radius: 16px 16px 0 0;
    }

    .dropdown-item:last-child {
      border-radius: 0 0 16px 16px;
    }

    .dropdown-item:first-child:last-child {
      border-radius: 16px;
    }

    .dropdown-item-info {
      font-size: 0.8em;
      color: #8e8e93;
      margin-left: 8px;
    }

    .dropdown-empty {
      padding: 24px 20px;
      text-align: center;
      color: #8e8e93;
      font-style: italic;
      font-size: 0.95em;
    }

    .button-group {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      align-items: center;
    }

    .primary-buttons {
      display: flex;
      gap: 12px;
      flex: 1;
    }

    /* Touch-friendly improvements */
    button {
      font-family: inherit;
      font-size: 1em;
      font-weight: 500;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      outline: none;
      min-height: 48px;
      -webkit-tap-highlight-color: transparent;
      backdrop-filter: blur(10px);
      /* ズーム防止設定 */
      touch-action: manipulation;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    .btn-primary {
      padding: 18px 28px;
      flex: 1;
      color: #ffffff;
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      box-shadow: 
        0 6px 20px rgba(59, 130, 246, 0.3),
        0 2px 8px rgba(59, 130, 246, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
      position: relative;
      overflow: hidden;
    }

    .btn-primary::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.6s ease;
    }

    .btn-primary:hover:not(:disabled) {
      background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
      transform: translateY(-2px);
      box-shadow: 
        0 12px 30px rgba(59, 130, 246, 0.4),
        0 6px 16px rgba(59, 130, 246, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }

    .btn-primary:hover:not(:disabled)::before {
      left: 100%;
    }

    .btn-primary:active:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 
        0 8px 20px rgba(59, 130, 246, 0.35),
        0 3px 10px rgba(59, 130, 246, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .btn-secondary {
      padding: 16px 24px;
      flex: 1;
      color: #007aff;
      background: #ffffff;
      border: 1px solid #007aff;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #f0f8ff;
      transform: translateY(-1px);
    }

    .btn-secondary:active:not(:disabled) {
      transform: translateY(0);
      background: #e6f3ff;
    }

    button:disabled {
      background: #f2f2f7 !important;
      color: #8e8e93 !important;
      border-color: #f2f2f7 !important;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }

    .menu-toggle {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: rgba(248, 250, 252, 0.9);
      backdrop-filter: blur(10px);
      color: #64748b;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2em;
      transition: all 0.3s ease;
      flex-shrink: 0;
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 
        0 4px 12px rgba(0, 0, 0, 0.03),
        0 1px 4px rgba(0, 0, 0, 0.02),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }

    .menu-toggle:hover {
      background: rgba(241, 245, 249, 0.95);
      color: #475569;
      transform: translateY(-1px);
      box-shadow: 
        0 8px 20px rgba(0, 0, 0, 0.05),
        0 3px 8px rgba(0, 0, 0, 0.03),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
    }

    .menu-toggle.active {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: #ffffff;
      transform: rotate(180deg);
      box-shadow: 
        0 8px 20px rgba(59, 130, 246, 0.3),
        0 3px 8px rgba(59, 130, 246, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    #adminMenu {
      margin-top: 16px;
      display: none;
      gap: 8px;
      opacity: 0;
      animation: slideDown 0.3s ease-out forwards;
    }

    #adminMenu.show {
      display: flex;
      flex-direction: column;
    }

    .admin-btn {
      padding: 12px 16px;
      font-size: 0.9em;
      background: #f2f2f7;
      color: #424245;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .admin-btn:hover {
      background: #e5e5ea;
    }

    .admin-btn.success {
      background: rgba(52, 199, 89, 0.95);
      color: #ffffff;
    }

    .admin-btn.success:hover {
      background: rgba(40, 167, 69, 0.95);
    }

    .admin-btn.danger {
      background: #ff3b30;
      color: #ffffff;
    }

    .admin-btn.danger:hover {
      background: #d70015;
    }

    .admin-btn.warning {
      background: #ff9500;
      color: #ffffff;
    }

    .admin-btn.warning:hover {
      background: #e6820e;
    }

    .records-section {
      background: rgba(249, 250, 251, 0.7);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 28px;
      margin-top: 32px;
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 
        0 8px 25px rgba(0, 0, 0, 0.03),
        0 3px 10px rgba(0, 0, 0, 0.02),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }

    .section-title {
      font-size: 0.9em;
      font-weight: 500;
      color: #424245;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
    }

    .record {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 18px 20px;
      margin-bottom: 12px;
      font-size: 0.95em;
      color: #1e293b;
      border: 1px solid rgba(255, 255, 255, 0.5);
      transition: all 0.3s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 
        0 4px 12px rgba(0, 0, 0, 0.02),
        0 1px 4px rgba(0, 0, 0, 0.01),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
      /* iPad の長押しメニューを無効化 */
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }

    .record:hover {
      background: rgba(255, 255, 255, 0.95);
      transform: translateX(4px) translateY(-1px);
      box-shadow: 
        0 8px 24px rgba(0, 0, 0, 0.04),
        0 3px 8px rgba(0, 0, 0, 0.02),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
    }

    .record.long-pressing {
      background: rgba(255, 59, 48, 0.1);
      border-color: rgba(255, 59, 48, 0.3);
    }

    .record:last-child {
      margin-bottom: 0;
    }

    .record-info {
      flex: 1;
    }

    .record-name {
      font-weight: 500;
      color: #1d1d1f;
      margin-bottom: 2px;
    }

    .record-time {
      font-size: 0.85em;
      color: #8e8e93;
      font-variant-numeric: tabular-nums;
    }

    .status-badge {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.75em;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-working {
      background: #e8f5e8;
      color: #28a745;
    }

    .status-completed {
      background: #e5e5ea;
      color: #8e8e93;
    }

    .status-overtime {
      background: #fff3cd;
      color: #856404;
    }

    .delete-btn {
      background: #ff3b30;
      color: #ffffff;
      border: none;
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 0.75em;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-left: 8px;
      opacity: 0;
      transform: scale(0.8);
      animation: deleteButtonAppear 0.3s ease-out forwards;
    }

    .delete-btn:hover {
      background: #d70015;
      transform: scale(1.05);
    }

    @keyframes deleteButtonAppear {
      from {
        opacity: 0;
        transform: scale(0.8);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* 確認ダイアログのスタイル */
    .confirm-dialog {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      animation: fadeIn 0.3s ease-out forwards;
    }

    .confirm-dialog-content {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 32px;
      margin: 20px;
      max-width: 400px;
      width: 100%;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.6);
      box-shadow: 
        0 25px 50px rgba(0, 0, 0, 0.1),
        0 10px 25px rgba(0, 0, 0, 0.06),
        0 0 0 1px rgba(255, 255, 255, 0.4);
      transform: scale(0.9);
      animation: dialogAppear 0.3s ease-out forwards;
    }

    .confirm-dialog h3 {
      font-size: 1.2em;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 16px;
    }

    .confirm-dialog p {
      color: #64748b;
      margin-bottom: 24px;
      line-height: 1.5;
    }

    .confirm-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .confirm-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 80px;
    }

    .confirm-btn.cancel {
      background: #f2f2f7;
      color: #424245;
    }

    .confirm-btn.cancel:hover {
      background: #e5e5ea;
    }

    .confirm-btn.delete {
      background: #ff3b30;
      color: #ffffff;
    }

    .confirm-btn.delete:hover {
      background: #d70015;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes dialogAppear {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .summary-button {
      background: linear-gradient(135deg, #a7f3d0 0%, #fde68a 100%);
      color: #374151;
      padding: 16px 24px;
      font-size: 0.95em;
      font-weight: 500;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      margin: 16px 0;
      transition: all 0.3s ease;
      width: 100%;
      box-shadow: 
        0 6px 20px rgba(167, 243, 208, 0.3),
        0 2px 8px rgba(167, 243, 208, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.6);
      position: relative;
      overflow: hidden;
    }

    .summary-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.6s ease;
    }

    .summary-button:hover {
      background: linear-gradient(135deg, #86efac 0%, #fcd34d 100%);
      transform: translateY(-2px);
      box-shadow: 
        0 12px 30px rgba(167, 243, 208, 0.4),
        0 6px 16px rgba(167, 243, 208, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.7);
    }

    .summary-button:hover::before {
      left: 100%;
    }

    .summary-button.close-mode {
      background: linear-gradient(135deg, #f87171 0%, #fbbf24 100%);
      color: #ffffff;
      box-shadow: 
        0 6px 20px rgba(248, 113, 113, 0.3),
        0 2px 8px rgba(248, 113, 113, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.6);
    }

    .summary-button.close-mode:hover {
      background: linear-gradient(135deg, #ef4444 0%, #f59e0b 100%);
      transform: translateY(-2px);
      box-shadow: 
        0 12px 30px rgba(248, 113, 113, 0.4),
        0 6px 16px rgba(248, 113, 113, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.7);
    }

    .summary-button.close-mode::before {
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    }

    .summary-button.close-mode:hover::before {
      left: 100%;
    }

    .summary-panel {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 32px;
      margin: 24px 0;
      border: 1px solid rgba(255, 255, 255, 0.6);
      box-shadow: 
        0 25px 50px rgba(0, 0, 0, 0.08),
        0 10px 25px rgba(0, 0, 0, 0.04),
        0 0 0 1px rgba(255, 255, 255, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
      display: none;
      animation: slideDown 0.4s ease-out;
      position: relative;
    }

    .summary-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.8), transparent);
      border-radius: 24px 24px 0 0;
    }

    .summary-header {
      text-align: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid #f0f0f0;
    }

    .summary-title {
      font-size: 1.3em;
      font-weight: 600;
      color: #1d1d1f;
      margin-bottom: 8px;
    }

    .summary-period {
      font-size: 0.9em;
      color: #8e8e93;
    }

    .summary-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 
        0 6px 20px rgba(0, 0, 0, 0.03),
        0 2px 8px rgba(0, 0, 0, 0.02),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 
        0 12px 30px rgba(0, 0, 0, 0.05),
        0 6px 16px rgba(0, 0, 0, 0.03),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }

    .stat-value {
      font-size: 1.5em;
      font-weight: 600;
      color: #007aff;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 0.8em;
      color: #8e8e93;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .summary-details {
      background: #f9f9f9;
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .summary-row:last-child {
      border-bottom: none;
    }

    .close-summary {
      background: #f2f2f7;
      color: #424245;
      padding: 10px 16px;
      font-size: 0.9em;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 16px;
      width: 100%;
      transition: all 0.2s ease;
    }

    .close-summary:hover {
      background: #e5e5ea;
    }

    .no-data {
      text-align: center;
      color: #8e8e93;
      font-style: italic;
      padding: 40px 20px;
    }

    /* Alert styles */
    .alert {
      position: fixed;
      top: 24px;
      left: 50%;
      transform: translateX(-50%);
      padding: 18px 28px;
      border-radius: 16px;
      color: #ffffff;
      font-weight: 500;
      font-size: 0.95em;
      z-index: 1000;
      box-shadow: 
        0 20px 40px rgba(0,0,0,0.15),
        0 8px 20px rgba(0,0,0,0.1),
        0 0 0 1px rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      opacity: 0;
      animation: slideInAlertTop 0.4s ease-out forwards;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .alert.success {
      background: rgba(52, 199, 89, 0.95);
    }

    .alert.error {
      background: rgba(255, 59, 48, 0.95);
    }

    .alert.info {
      background: rgba(0, 122, 255, 0.95);
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes slideInAlertTop {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-100%) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0) scale(1);
      }
    }

    @keyframes slideOutAlertTop {
      from {
        opacity: 1;
        transform: translateX(-50%) translateY(0) scale(1);
      }
      to {
        opacity: 0;
        transform: translateX(-50%) translateY(-100%) scale(0.9);
      }
    }

    /* iPad styles */
    @media (min-width: 768px) and (max-width: 1024px) {
      .container {
        max-width: 600px;
        padding: 50px;
      }

      .clock {
        margin-bottom: 50px;
        padding: 24px;
      }

      .clock-date {
        font-size: 1.2em;
        margin-bottom: 10px;
      }

      .clock-time {
        font-size: 2.6em;
      }

      .form-group {
        margin-bottom: 30px;
      }

      input[type="text"] {
        padding: 20px 24px;
        font-size: 1.1em;
      }

      #empName {
        padding-right: 52px;
      }

      #searchEmpName {
        padding-right: 52px;
      }

      .clear-btn {
        width: 32px;
        height: 32px;
        font-size: 18px;
      }

      .btn-primary {
        padding: 20px 32px;
        font-size: 1.1em;
      }

      .menu-toggle {
        width: 50px;
        height: 50px;
        font-size: 1.3em;
      }

      .admin-btn {
        padding: 16px 20px;
        font-size: 1em;
      }

      .records-section {
        padding: 30px;
      }

      .record {
        padding: 20px;
        margin-bottom: 12px;
      }

      .record-name {
        font-size: 1.05em;
      }

      .record-time {
        font-size: 0.95em;
      }

      /* iPad用ドロップダウン調整 */
      .dropdown-menu {
        max-height: 320px;
      }

      .dropdown-item {
        padding: 18px 24px;
        font-size: 1.1em;
        min-height: 60px;
      }

      .dropdown-item-info {
        font-size: 0.9em;
      }

      .dropdown-empty {
        padding: 24px;
        font-size: 1em;
      }
    }

    /* Mobile styles */
    @media (max-width: 767px) {
      .container {
        padding: 30px 20px;
        margin: 10px;
      }

      h1 {
        font-size: 1.5em;
      }

      .button-group {
        flex-direction: column;
        gap: 12px;
      }

      .primary-buttons {
        width: 100%;
      }

      .menu-toggle {
        align-self: center;
      }

      .alert {
        right: 10px;
        left: 10px;
        transform: translateX(0);
        animation: slideInAlertMobile 0.3s ease-out forwards;
      }

      /* スマホ用ドロップダウン調整 */
      .dropdown-menu {
        max-height: 240px;
        border-radius: 12px;
      }

      .dropdown-item {
        padding: 16px 18px;
        font-size: 1em;
        min-height: 52px;
      }

      .dropdown-item-info {
        font-size: 0.85em;
        margin-left: 6px;
      }

      .dropdown-empty {
        padding: 20px 16px;
        font-size: 0.9em;
      }

      .dropdown-item:first-child {
        border-radius: 12px 12px 0 0;
      }

      .dropdown-item:last-child {
        border-radius: 0 0 12px 12px;
      }

      .dropdown-item:first-child:last-child {
        border-radius: 12px;
      }

      @keyframes slideInAlertMobile {
        from {
          opacity: 0;
          transform: translateY(-100%);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    }

    /* Large screens */
    @media (min-width: 1025px) {
      .container {
        max-width: 500px;
      }
    }

    /* Focus styles for accessibility */
    button:focus-visible {
      outline: 2px solid #007aff;
      outline-offset: 2px;
    }

    input:focus-visible {
      outline: none;
    }
  </style>
</head>
<body>
  <div class="logo">
    <img src="logo.png" alt="勤怠管理ロゴ">
  </div>
  <div class="container">
    <div class="clock">
      <div class="clock-date" id="clockDate">2025年6月17日（火）</div>
      <div class="clock-time" id="clockTime">14:32:45</div>
    </div>
    <div class="form-group">
      <label for="empName">名前</label>
      <div class="input-wrapper">
        <input type="text" id="empName" placeholder="氏名を入力">
        <button type="button" class="clear-btn" id="clearEmpNameBtn">×</button>
        <div class="dropdown-menu" id="empNameDropdown"></div>
      </div>
    </div>
    <div class="form-group button-group">
      <div class="primary-buttons">
        <button id="btnClockIn" class="btn-primary" disabled>出勤</button>
        <button id="btnClockOut" class="btn-primary" disabled>退勤</button>
      </div>
      <button id="toggleMenu" class="menu-toggle">⚙</button>
    </div>
    <div id="adminMenu">
      <button id="backupBtn" class="admin-btn success">バックアップ</button>
      <button id="restoreBtn" class="admin-btn warning">リストア</button>
      <input type="file" id="restoreFile" style="display:none;">
      <button id="clearAllBtn" class="admin-btn danger">全データ削除</button>
    </div>
    <div class="form-group">
      <label for="searchEmpName">検索</label>
      <div class="input-wrapper">
        <input type="text" id="searchEmpName" placeholder="名前で検索">
        <button type="button" class="clear-btn" id="clearSearchBtn">×</button>
        <div class="dropdown-menu" id="searchEmpNameDropdown"></div>
      </div>
    </div>
    <div class="records-section">
      <div class="section-title">勤怠記録</div>
      <div id="summaryContainer"></div>
      <div id="empResult"></div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'timeCards';

    // 効果音再生関数
    function playSuccessSound(type = 'in') {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        if (type === 'in') {
          // 出勤時：明るい上昇音
          playChord(audioContext, [523.25, 659.25, 783.99], 0.3, 0.1); // C5-E5-G5
          setTimeout(() => playChord(audioContext, [783.99, 987.77, 1174.66], 0.3, 0.1), 150); // G5-B5-D6
        } else {
          // 退勤時：落ち着いた下降音
          playChord(audioContext, [783.99, 659.25, 523.25], 0.3, 0.1); // G5-E5-C5
          setTimeout(() => playChord(audioContext, [523.25, 415.30, 329.63], 0.3, 0.1), 150); // C5-Ab4-E4
        }
      } catch (error) {
        console.log('音声再生に対応していません:', error);
      }
    }

    function playChord(audioContext, frequencies, volume = 0.3, duration = 0.2) {
      frequencies.forEach(freq => {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
        oscillator.type = 'sine';
        
        // 音量の設定（フェードイン・フェードアウト）
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(volume, audioContext.currentTime + 0.01);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + duration);
      });
    }

    // 日本時間取得（より正確な方法）
    function getJstDate() {
      return new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Tokyo"}));
    }

    // 時計更新
    function updateClock() {
      const now = getJstDate();
      const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
      
      const year = now.getFullYear();
      const month = now.getMonth() + 1;
      const date = now.getDate();
      const weekday = weekdays[now.getDay()];
      
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      
      const dateStr = `${year}年${month}月${date}日（${weekday}）`;
      const timeStr = `${hours}:${minutes}:${seconds}`;
      
      document.getElementById('clockDate').textContent = dateStr;
      document.getElementById('clockTime').textContent = timeStr;
    }

    // YYYY-MM-DD形式の日付文字列
    function getLocalDateString(date) {
      // 日本時間で計算する場合
      const jstDate = date || getJstDate();
      const y = jstDate.getFullYear();
      const m = String(jstDate.getMonth()+1).padStart(2,'0');
      const d = String(jstDate.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }

    // 11日区切りの期間取得
    function getCurrentPeriod() {
      const today = getJstDate();
      const day = today.getDate();
      const month = today.getMonth();
      const year = today.getFullYear();
      
      let periodStart, periodEnd;
      
      if (day >= 11) {
        // 11日以降なら、当月11日～翌月10日
        periodStart = new Date(year, month, 11);
        periodEnd = new Date(year, month + 1, 10);
      } else {
        // 10日以前なら、前月11日～当月10日
        periodStart = new Date(year, month - 1, 11);
        periodEnd = new Date(year, month, 10);
      }
      
      return { start: periodStart, end: periodEnd };
    }

    // 勤務時間計算（時間差分）
    function calculateWorkingHours(checkIn, checkOut) {
      const start = new Date(`1970-01-01T${checkIn}`);
      const end = new Date(`1970-01-01T${checkOut}`);
      return (end - start) / (1000 * 60 * 60); // 時間単位
    }

    // 早朝勤務時間計算（8:30まで）
    function calculateEarlyMorningHours(checkIn, checkOut) {
      const start = new Date(`1970-01-01T${checkIn}`);
      const end = new Date(`1970-01-01T${checkOut}`);
      const limit = new Date('1970-01-01T08:30');
      
      if (end <= limit) {
        return (end - start) / (1000 * 60 * 60);
      } else if (start < limit) {
        return (limit - start) / (1000 * 60 * 60);
      }
      return 0;
    }

    // 夕方勤務時間計算（16:00以降）
    function calculateEveningHours(checkIn, checkOut) {
      const start = new Date(`1970-01-01T${checkIn}`);
      const end = new Date(`1970-01-01T${checkOut}`);
      const limit = new Date('1970-01-01T16:00');
      
      if (start >= limit) {
        return (end - start) / (1000 * 60 * 60);
      } else if (end > limit) {
        return (end - limit) / (1000 * 60 * 60);
      }
      return 0;
    }

    // 既存の名前リストを取得（最新記録順）
    function getExistingNames() {
      const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
      const names = Object.keys(data);
      
      // 各名前の最新記録日を取得してソート
      const namesWithLastDate = names.map(name => {
        const dates = Object.keys(data[name]).sort(); // 日付をソート
        const lastDate = dates[dates.length - 1]; // 最新の日付
        return { name, lastDate };
      });
      
      // 最新記録日の降順でソート（新しい順）
      namesWithLastDate.sort((a, b) => {
        if (!a.lastDate) return 1;
        if (!b.lastDate) return -1;
        return b.lastDate.localeCompare(a.lastDate);
      });
      
      return namesWithLastDate.map(item => item.name);
    }

    // クリアボタンの表示制御（汎用関数）
    function updateClearButton(inputId, clearBtnId) {
      const input = document.getElementById(inputId);
      const clearBtn = document.getElementById(clearBtnId);
      
      if (input && clearBtn) {
        if (input.value.trim()) {
          clearBtn.classList.add('show');
        } else {
          clearBtn.classList.remove('show');
        }
      }
    }

    // ドロップダウン制御用のフラグ
    let isDropdownActionInProgress = false;

    // ドロップダウンメニューを表示
    function showDropdown(inputId, dropdownId) {
      if (isDropdownActionInProgress) return;
      
      // 他のドロップダウンを先に閉じる
      if (dropdownId === 'empNameDropdown') {
        hideDropdown('searchEmpNameDropdown');
      } else if (dropdownId === 'searchEmpNameDropdown') {
        hideDropdown('empNameDropdown');
      }
      
      const input = document.getElementById(inputId);
      const dropdown = document.getElementById(dropdownId);
      const names = getExistingNames();
      const inputValue = input.value.toLowerCase().trim();
      
      // 入力値でフィルタリング
      const filteredNames = names.filter(name => 
        name.toLowerCase().includes(inputValue)
      );
      
      dropdown.innerHTML = '';
      
      if (filteredNames.length === 0) {
        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'dropdown-empty';
        emptyDiv.textContent = inputValue ? '該当する名前が見つかりません' : '記録された名前はありません';
        dropdown.appendChild(emptyDiv);
      } else {
        filteredNames.forEach(name => {
          const item = document.createElement('div');
          item.className = 'dropdown-item';
          
          const nameSpan = document.createElement('span');
          nameSpan.textContent = name;
          
          // 最後の記録日を取得
          const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
          const lastDate = Object.keys(data[name]).sort().pop();
          const infoSpan = document.createElement('span');
          infoSpan.className = 'dropdown-item-info';
          infoSpan.textContent = lastDate ? `最終: ${lastDate}` : '';
          
          item.appendChild(nameSpan);
          item.appendChild(infoSpan);
          
          const handleItemClick = () => {
            isDropdownActionInProgress = true;
            input.value = name;
            hideDropdown(dropdownId);
            
            // iPad対応：キーボードも閉じる
            input.blur();
    
            if (inputId === 'empName') {
              // 出勤・退勤フィールドの場合：選択した名前でボタン状態を更新
              updateButtons(name);
              // クリアボタンの表示制御を更新
              updateClearButton('empName', 'clearEmpNameBtn');
            } else if (inputId === 'searchEmpName') {
              // 検索フィールドの場合：検索結果のみ更新、ボタン状態は変更しない
              displayEmpRecords();
              // クリアボタンの表示制御を更新
              updateClearButton('searchEmpName', 'clearSearchBtn');
            }
            
            // フラグをリセット
            setTimeout(() => {
              isDropdownActionInProgress = false;
            }, 300);
          };

          // iPad対応：touchend のみ使用（clickとの重複を避ける）
          item.addEventListener('touchend', (e) => {
            e.preventDefault();
            e.stopPropagation();
            handleItemClick();
          });
          
          // デスクトップ用のclickイベント（タッチデバイスでは発火しない）
          item.addEventListener('click', (e) => {
            // タッチイベントがある場合はclickを無視
            if (e.type === 'click' && 'ontouchstart' in window) {
              return;
            }
            handleItemClick();
          });
          
          dropdown.appendChild(item);
        });
      }
      
      dropdown.classList.add('show');
    }

    // ドロップダウンメニューを非表示
    function hideDropdown(dropdownId) {
      const dropdown = document.getElementById(dropdownId);
      dropdown.classList.remove('show');
    }

    // 全てのドロップダウンを非表示
    function hideAllDropdowns() {
      hideDropdown('empNameDropdown');
      hideDropdown('searchEmpNameDropdown');
    }

    // 確認ダイアログを表示
    function showConfirmDialog(message, onConfirm) {
      const dialog = document.createElement('div');
      dialog.className = 'confirm-dialog';
      
      dialog.innerHTML = `
        <div class="confirm-dialog-content">
          <h3>確認</h3>
          <p>${message}</p>
          <div class="confirm-buttons">
            <button class="confirm-btn cancel">キャンセル</button>
            <button class="confirm-btn delete">削除</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(dialog);
      
      const cancelBtn = dialog.querySelector('.cancel');
      const deleteBtn = dialog.querySelector('.delete');
      
      const closeDialog = () => {
        dialog.style.opacity = '0';
        setTimeout(() => {
          if (document.body.contains(dialog)) {
            document.body.removeChild(dialog);
          }
        }, 300);
      };
      
      cancelBtn.addEventListener('click', closeDialog);
      deleteBtn.addEventListener('click', () => {
        onConfirm();
        closeDialog();
      });
      
      // 背景クリックで閉じる
      dialog.addEventListener('click', (e) => {
        if (e.target === dialog) {
          closeDialog();
        }
      });
    }

    // 個別データ削除
    function deleteRecord(name, date, recordIndex) {
      const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
      
      if (data[name] && data[name][date] && data[name][date][recordIndex]) {
        data[name][date].splice(recordIndex, 1);
        
        // 日付に記録がなくなったら日付も削除
        if (data[name][date].length === 0) {
          delete data[name][date];
        }
        
        // 名前に記録がなくなったら名前も削除
        if (Object.keys(data[name]).length === 0) {
          delete data[name];
        }
        
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        displayEmpRecords();
        updateButtons(document.getElementById('empName').value.trim());
        showAlert('記録を削除しました', 'success');
      }
    }

    // 長押し機能を追加
    function addLongPressToRecord(element, name, date, recordIndex) {
      let pressTimer = null;
      let isLongPress = false;
      let startCoords = { x: 0, y: 0 };
      
      const startPress = (e) => {
        // 削除ボタンがクリックされた場合は長押し処理をスキップ
        if (e.target.classList.contains('delete-btn')) {
          return;
        }
        
        // iPad のテキスト選択を防ぐ
        e.preventDefault();
        
        isLongPress = false;
        element.classList.add('long-pressing');
        
        // タッチ座標を記録
        if (e.touches) {
          startCoords.x = e.touches[0].clientX;
          startCoords.y = e.touches[0].clientY;
        } else {
          startCoords.x = e.clientX;
          startCoords.y = e.clientY;
        }
        
        pressTimer = setTimeout(() => {
          isLongPress = true;
          element.classList.remove('long-pressing');
          showDeleteButton(element, name, date, recordIndex);
          
          // 触覚フィードバック（対応デバイスのみ）
          if (navigator.vibrate) {
            navigator.vibrate(50);
          }
        }, 3000); // 3秒
      };
      
      const endPress = (e) => {
        // 削除ボタンがクリックされた場合は処理をスキップ
        if (e && e.target && e.target.classList.contains('delete-btn')) {
          return;
        }
        
        clearTimeout(pressTimer);
        element.classList.remove('long-pressing');
      };
      
      const moveHandler = (e) => {
        // 削除ボタンがある場合は移動判定をスキップ
        if (element.querySelector('.delete-btn')) {
          return;
        }
        
        // 指が大きく動いた場合は長押しをキャンセル
        let currentX, currentY;
        if (e.touches) {
          currentX = e.touches[0].clientX;
          currentY = e.touches[0].clientY;
        } else {
          currentX = e.clientX;
          currentY = e.clientY;
        }
        
        const distance = Math.sqrt(
          Math.pow(currentX - startCoords.x, 2) + 
          Math.pow(currentY - startCoords.y, 2)
        );
        
        // 20px以上動いたらキャンセル
        if (distance > 20) {
          endPress();
        }
      };
      
      // タッチイベント（iPad対応）
      element.addEventListener('touchstart', startPress, { passive: false });
      element.addEventListener('touchend', endPress, { passive: true });
      element.addEventListener('touchmove', moveHandler, { passive: true });
      element.addEventListener('touchcancel', endPress, { passive: true });
      
      // マウスイベント（デスクトップ用）
      element.addEventListener('mousedown', startPress);
      element.addEventListener('mouseup', endPress);
      element.addEventListener('mouseleave', endPress);
      element.addEventListener('mousemove', moveHandler);
      
      // クリックイベントを無効化（長押し後、ただし削除ボタン以外）
      element.addEventListener('click', (e) => {
        if (isLongPress && !e.target.classList.contains('delete-btn')) {
          e.preventDefault();
          e.stopPropagation();
        }
      });
      
      // コンテキストメニューを無効化（右クリック防止）
      element.addEventListener('contextmenu', (e) => {
        e.preventDefault();
      });
    }

    // 削除ボタンを表示
    function showDeleteButton(recordElement, name, date, recordIndex) {
      // 既存の削除ボタンがあれば削除
      const existingBtn = recordElement.querySelector('.delete-btn');
      if (existingBtn) {
        existingBtn.remove();
      }
      
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'delete-btn';
      deleteBtn.textContent = '削除';
      
      // 削除ボタンのイベント処理を強化
      const handleDeleteClick = (e) => {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        
        showConfirmDialog(
          'この勤怠記録を削除しますか？<br>この操作は取り消せません。',
          () => deleteRecord(name, date, recordIndex)
        );
      };
      
      // 複数のイベントタイプで確実にキャッチ
      deleteBtn.addEventListener('click', handleDeleteClick, true);
      deleteBtn.addEventListener('touchend', handleDeleteClick, true);
      
      // 削除ボタン自体の長押しやドラッグを防ぐ
      deleteBtn.addEventListener('touchstart', (e) => {
        e.stopPropagation();
      }, true);
      
      deleteBtn.addEventListener('mousedown', (e) => {
        e.stopPropagation();
      }, true);
      
      recordElement.appendChild(deleteBtn);
      
      // 5秒後に自動で削除ボタンを消す
      setTimeout(() => {
        if (deleteBtn.parentNode) {
          deleteBtn.remove();
        }
      }, 5000);
    }

    function showMonthlySummary(name) {
      const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
      const userData = data[name];
      if (!userData) return;

      const period = getCurrentPeriod();
      
      // 期間内のデータを集計
      let totalDays = 0;
      let totalHours = 0;
      let totalEarlyMorning = 0;
      let totalEvening = 0;
      let incompleteCount = 0;

      const today = getLocalDateString(getJstDate());

      Object.keys(userData).forEach(date => {
        const recordDate = new Date(date);
        if (recordDate >= period.start && recordDate <= period.end) {
          userData[date].forEach(rec => {
            if (rec.checkIn) {
              totalDays++;
              if (rec.checkOut) {
                const hours = calculateWorkingHours(rec.checkIn, rec.checkOut);
                const earlyMorning = calculateEarlyMorningHours(rec.checkIn, rec.checkOut);
                const evening = calculateEveningHours(rec.checkIn, rec.checkOut);
                
                totalHours += hours;
                totalEarlyMorning += earlyMorning;
                totalEvening += evening;
              } else {
                // 勤怠記録と同じ判定ロジック：今日以外で未退勤のみ要確認
                const isToday = date === today;
                if (!isToday) {
                  incompleteCount++;
                }
              }
            }
          });
        }
      });

      const totalNormal = totalHours - totalEarlyMorning - totalEvening;
      const totalOvertime = Math.max(0, totalHours - totalDays * 8); // 8時間超過分
      
      const monthNames = ["1月", "2月", "3月", "4月", "5月", "6月", 
                         "7月", "8月", "9月", "10月", "11月", "12月"];
      
      const startMonth = period.start.getMonth();
      const endMonth = period.end.getMonth();
      let periodLabel;
      
      if (startMonth === endMonth) {
        periodLabel = period.start.getFullYear() + "年 " + monthNames[startMonth];
      } else {
        const startYear = period.start.getFullYear();
        const endYear = period.end.getFullYear();
        if (startYear === endYear) {
          periodLabel = startYear + "年 " + monthNames[startMonth] + "11日～" + monthNames[endMonth] + "10日";
        } else {
          periodLabel = startYear + "年" + monthNames[startMonth] + "11日～" + endYear + "年" + monthNames[endMonth] + "10日";
        }
      }

      const averageHours = totalDays > 0 ? (totalHours / totalDays).toFixed(1) : '0.0';

      const summaryContainer = document.getElementById('summaryContainer');
      
      // 既存のサマリーパネルを削除
      const existingPanel = document.getElementById('summaryPanel');
      if (existingPanel) {
        existingPanel.remove();
      }
      
      const summaryPanel = document.createElement('div');
      summaryPanel.className = 'summary-panel';
      summaryPanel.id = 'summaryPanel';
      summaryPanel.style.display = 'block';
      
      summaryPanel.innerHTML = 
        '<div class="summary-header">' +
          '<div class="summary-title">' + name + 'さんの月次サマリー</div>' +
          '<div class="summary-period">' + periodLabel + '</div>' +
        '</div>' +
        
        '<div class="summary-stats">' +
          '<div class="stat-card">' +
            '<div class="stat-value">' + totalDays + '</div>' +
            '<div class="stat-label">出勤日数</div>' +
          '</div>' +
          '<div class="stat-card">' +
            '<div class="stat-value">' + totalHours.toFixed(1) + '</div>' +
            '<div class="stat-label">総勤務時間</div>' +
          '</div>' +
          '<div class="stat-card">' +
            '<div class="stat-value">' + totalOvertime.toFixed(1) + '</div>' +
            '<div class="stat-label">残業時間</div>' +
          '</div>' +
          '<div class="stat-card">' +
            '<div class="stat-value">' + incompleteCount + '</div>' +
            '<div class="stat-label">要確認</div>' +
          '</div>' +
        '</div>' +

        '<div class="summary-details">' +
          '<div style="font-weight: 600; margin-bottom: 12px; color: #424245;">詳細</div>' +
          '<div class="summary-row">' +
            '<span>平均勤務時間/日</span>' +
            '<span>' + averageHours + '時間</span>' +
          '</div>' +
          '<div class="summary-row">' +
            '<span>通常勤務時間</span>' +
            '<span>' + totalNormal.toFixed(1) + '時間</span>' +
          '</div>' +
          '<div class="summary-row">' +
            '<span>早朝勤務時間</span>' +
            '<span>' + totalEarlyMorning.toFixed(1) + '時間</span>' +
          '</div>' +
          '<div class="summary-row">' +
            '<span>夕方勤務時間</span>' +
            '<span>' + totalEvening.toFixed(1) + '時間</span>' +
          '</div>' +
        '</div>';
        
      summaryContainer.appendChild(summaryPanel);
      
      // サマリーボタンを「閉じる」ボタンに変更
      const summaryButton = document.querySelector('.summary-button');
      if (summaryButton) {
        summaryButton.textContent = 'サマリーを閉じる';
        summaryButton.classList.add('close-mode');
        summaryButton.onclick = () => toggleSummary();
      }
    }

    // サマリーのトグル機能
    function toggleSummary() {
      const panel = document.getElementById('summaryPanel');
      const button = document.querySelector('.summary-button');
      
      if (panel && button) {
        if (panel.style.display === 'block') {
          // サマリーを閉じる
          panel.style.display = 'none';
          // ボタンテキストを元に戻す
          const name = button.getAttribute('data-name');
          if (name) {
            button.textContent = `${name}さんの月次サマリーを表示`;
            button.classList.remove('close-mode');
            button.onclick = () => showMonthlySummary(name);
          }
        }
      }
    }

    // サマリーを閉じる（既存の検索ロジックとの互換性のため）
    function closeSummary() {
      const panel = document.getElementById('summaryPanel');
      const button = document.querySelector('.summary-button');
      
      if (panel) {
        panel.style.display = 'none';
      }
      
      if (button) {
        // ボタンテキストを元に戻す
        const name = button.getAttribute('data-name');
        if (name) {
          button.textContent = `${name}さんの月次サマリーを表示`;
          button.classList.remove('close-mode');
          button.onclick = () => showMonthlySummary(name);
        }
      }
    }

    // 出勤／退勤
    function saveEmpPair(name, type) {
      const now = getJstDate();
      const today = getLocalDateString(now);
      const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
      if (!data[name]) data[name] = {};
      if (!data[name][today]) data[name][today] = [];
      const recs = data[name][today];
      const last = recs.length ? recs[recs.length-1] : null;

      if (type === 'in') {
        if (last && last.checkOut === null) {
          showAlert('連続した出勤はできません', 'error');
          return;
        }
        recs.push({ checkIn: now.toTimeString().slice(0,5), checkOut: null });
      } else {
        if (!last || last.checkOut !== null) {
          showAlert('先に出勤してください', 'error');
          return;
        }
        last.checkOut = now.toTimeString().slice(0,5);
      }

      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      playSuccessSound(type);
      showAlert('記録しました', 'success');
      document.getElementById('empName').value = '';
      updateButtons('');
      // 名前フィールドのクリアボタンも非表示にする
      updateClearButton('empName', 'clearEmpNameBtn');
      displayEmpRecords();
    }

    // アラート表示
    function showAlert(message, type = 'info') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert ${type}`;
      alertDiv.textContent = message;
      
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        alertDiv.style.animation = 'slideOutAlertTop 0.3s ease-in forwards';
        setTimeout(() => {
          if (document.body.contains(alertDiv)) {
            document.body.removeChild(alertDiv);
          }
        }, 300);
      }, 3000);
    }

    // ボタン制御
    function updateButtons(name) {
      const btnIn = document.getElementById('btnClockIn');
      const btnOut = document.getElementById('btnClockOut');
      if (!name) {
        btnIn.disabled = true;
        btnOut.disabled = true;
        return;
      }
      const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}')[name] || {};
      const dates = Object.keys(data).sort().reverse();
      const lastDate = dates[0];
      const lastRec = lastDate ? data[lastDate][data[lastDate].length-1] : null;
      const today = getLocalDateString(getJstDate());
      
      if (!lastRec || lastRec.checkOut !== null || lastDate !== today) {
        btnIn.disabled = false;
        btnOut.disabled = true;
      } else {
        btnIn.disabled = true;
        btnOut.disabled = false;
      }
    }

    // 一覧表示＋検索
    function displayEmpRecords() {
      const filter = document.getElementById('searchEmpName').value.trim().toLowerCase();
      const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
      const container = document.getElementById('empResult');
      container.innerHTML = '';
      
      const today = getLocalDateString(getJstDate());
      
      let hasRecords = false;
      let searchedNames = [];
      
      Object.keys(data)
        .filter(name => name.toLowerCase().includes(filter))
        .forEach(name => {
          // 検索にヒットした名前を記録
          if (!searchedNames.includes(name)) {
            searchedNames.push(name);
          }
          
         Object.keys(data[name]).sort().reverse().forEach(date => {
    // 同じ日の記録を新しい順（逆順）で表示
    const records = data[name][date];
    records.slice().reverse().forEach((rec, reverseIndex) => {
      if (rec.checkIn) {
        // 実際の配列での正しいインデックスを計算（削除機能用）
        const recordIndex = records.length - 1 - reverseIndex;
        
        hasRecords = true;
        const div = document.createElement('div');
        div.className = 'record';
        
        const info = document.createElement('div');
        info.className = 'record-info';
        
        const nameDiv = document.createElement('div');
        nameDiv.className = 'record-name';
        nameDiv.textContent = name;
        
        const timeDiv = document.createElement('div');
        timeDiv.className = 'record-time';
        timeDiv.textContent = `${date} ${rec.checkIn}${rec.checkOut ? ` - ${rec.checkOut}` : ''}`;
        
        info.appendChild(nameDiv);
        info.appendChild(timeDiv);
        
        const badge = document.createElement('div');
        
        // 日付チェックを追加
        const isToday = date === today;
        let statusClass, statusText;
        
        if (rec.checkOut) {
          statusClass = 'status-completed';
          statusText = '完了';
        } else if (isToday) {
          statusClass = 'status-working';
          statusText = '勤務中';
        } else {
          statusClass = 'status-overtime';
          statusText = '要確認';
        }
        
        badge.className = `status-badge ${statusClass}`;
        badge.textContent = statusText;
        
        div.appendChild(info);
        div.appendChild(badge);
        
        // 長押し機能を追加（正しいrecordIndexを使用）
        addLongPressToRecord(div, name, date, recordIndex);
        
        container.appendChild(div);
      }
    });
  });
        });
      
      // 既存のサマリーをチェック
      const existingButton = document.querySelector('.summary-button');
      const existingPanel = document.getElementById('summaryPanel');
      
      // 現在のサマリーが表示されている名前を取得
      let currentSummaryName = null;
      if (existingPanel && existingPanel.style.display === 'block') {
        const titleElement = existingPanel.querySelector('.summary-title');
        if (titleElement) {
          const titleText = titleElement.textContent;
          const match = titleText.match(/^(.+)さんの月次サマリー$/);
          if (match) {
            currentSummaryName = match[1];
          }
        }
      }
      
      // サマリーを閉じる条件：
      // 1. 検索結果が1人でない
      // 2. 現在のサマリーの名前が検索結果に含まれていない
      if (currentSummaryName && 
          (searchedNames.length !== 1 || !searchedNames.includes(currentSummaryName))) {
        closeSummary();
      }
      
      // 検索結果が1人の場合、月次サマリーボタンを表示
      if (searchedNames.length === 1 && hasRecords) {
        if (!existingButton) {
          const summaryButton = document.createElement('button');
          summaryButton.className = 'summary-button';
          summaryButton.textContent = `${searchedNames[0]}さんの月次サマリーを表示`;
          summaryButton.onclick = () => showMonthlySummary(searchedNames[0]);
          // データ属性で名前を保存（後でトグル機能で使用）
          summaryButton.setAttribute('data-name', searchedNames[0]);
          document.getElementById('summaryContainer').appendChild(summaryButton);
        } else {
          // ボタンが既にある場合は内容を更新
          existingButton.textContent = `${searchedNames[0]}さんの月次サマリーを表示`;
          existingButton.onclick = () => showMonthlySummary(searchedNames[0]);
          existingButton.setAttribute('data-name', searchedNames[0]);
        }
      } else {
        // 1人以外の場合はボタンを削除
        if (existingButton) {
          existingButton.remove();
        }
      }
      
      if (!hasRecords) {
        const noData = document.createElement('div');
        noData.className = 'no-data';
        noData.textContent = 'まだ記録がありません';
        container.appendChild(noData);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const nameInput = document.getElementById('empName');
      const searchInput = document.getElementById('searchEmpName');
      const btnClockIn = document.getElementById('btnClockIn');
      const btnClockOut = document.getElementById('btnClockOut');
      const clearSearchBtn = document.getElementById('clearSearchBtn');
      const clearEmpNameBtn = document.getElementById('clearEmpNameBtn');
      
      // ドロップダウン機能の設定
      nameInput.addEventListener('focus', () => {
        if (!isDropdownActionInProgress) {
          showDropdown('empName', 'empNameDropdown');
          // フォーカス時にもクリアボタンの表示状態をチェック
          updateClearButton('empName', 'clearEmpNameBtn');
        }
      });
      
      nameInput.addEventListener('input', () => {
        if (!isDropdownActionInProgress) {
          updateButtons(nameInput.value.trim());
          showDropdown('empName', 'empNameDropdown');
          // クリアボタンの表示制御
          updateClearButton('empName', 'clearEmpNameBtn');
        }
      });
      
      // エンターキーでプルダウンとキーボードを閉じる
      nameInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          hideDropdown('empNameDropdown');
          nameInput.blur(); // iPad対応：キーボードも閉じる
          e.preventDefault(); // フォームの送信を防ぐ
        }
      });
      
      searchInput.addEventListener('focus', () => {
        showDropdown('searchEmpName', 'searchEmpNameDropdown');
        // フォーカス時にもクリアボタンの表示状態をチェック
        updateClearButton('searchEmpName', 'clearSearchBtn');
      });
      
      searchInput.addEventListener('input', () => {
        if (!isDropdownActionInProgress) {
          displayEmpRecords();
          showDropdown('searchEmpName', 'searchEmpNameDropdown');
          // クリアボタンの表示制御
          updateClearButton('searchEmpName', 'clearSearchBtn');
        }
      });
      
      // 検索フィールドでもエンターキーでプルダウンとキーボードを閉じる
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          hideDropdown('searchEmpNameDropdown');
          searchInput.blur(); // iPad対応：キーボードも閉じる
          e.preventDefault(); // フォームの送信を防ぐ
        }
      });
      
      // 名前フィールドのクリアボタンのクリックイベント
      clearEmpNameBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        nameInput.value = '';
        clearEmpNameBtn.classList.remove('show');
        hideDropdown('empNameDropdown');
        updateButtons(''); // ボタン状態をリセット
        
        // 名前フィールドにフォーカスを戻す
        nameInput.focus();
      });
      
      // 検索フィールドのクリアボタンのクリックイベント
      clearSearchBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        searchInput.value = '';
        clearSearchBtn.classList.remove('show');
        hideDropdown('searchEmpNameDropdown');
        displayEmpRecords(); // 検索結果をリセット
        
        // 検索フィールドにフォーカスを戻す
        searchInput.focus();
      });
      
      // 外部クリック・タッチでドロップダウンとキーボードを閉じる（iPad対応改善）
      const hideDropdownsOnOutsideTouch = (e) => {
        if (isDropdownActionInProgress) return;
        
        if (!e.target.closest('.input-wrapper')) {
          isDropdownActionInProgress = true;
          hideAllDropdowns();
          
          // iPad対応：キーボードも閉じる
          const activeElement = document.activeElement;
          if (activeElement && (activeElement.id === 'empName' || activeElement.id === 'searchEmpName')) {
            activeElement.blur();
          }
          
          setTimeout(() => {
            isDropdownActionInProgress = false;
          }, 300);
        }
      };
      
      // タッチデバイス用（iPadなど）
      document.addEventListener('touchstart', hideDropdownsOnOutsideTouch, { passive: true });
      
      // デスクトップ用（タッチデバイスでない場合のみ）
      if (!('ontouchstart' in window)) {
        document.addEventListener('click', hideDropdownsOnOutsideTouch);
      }
      
      // ESCキーでドロップダウンとキーボードを閉じる
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          hideAllDropdowns();
          // iPad対応：キーボードも閉じる
          const activeElement = document.activeElement;
          if (activeElement && (activeElement.id === 'empName' || activeElement.id === 'searchEmpName')) {
            activeElement.blur();
          }
        }
      });
      
      document.getElementById('toggleMenu').addEventListener('click', (e) => {
        const menu = document.getElementById('adminMenu');
        const toggle = document.getElementById('toggleMenu');
        const isOpen = menu.style.display === 'flex';
        
        if (isOpen) {
          menu.style.display = 'none';
          menu.classList.remove('show');
          toggle.classList.remove('active');
        } else {
          menu.style.display = 'flex';
          menu.classList.add('show');
          toggle.classList.add('active');
        }
      });

      btnClockIn.addEventListener('click', () => {
        saveEmpPair(nameInput.value.trim(), 'in');
      });

      btnClockOut.addEventListener('click', () => {
        saveEmpPair(nameInput.value.trim(), 'out');
      });
      
      document.getElementById('backupBtn').addEventListener('click', () => {
        const blob = new Blob([localStorage.getItem(STORAGE_KEY) || '{}'], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); 
        a.href = url; 
        a.download = 'timecards_backup.json'; 
        a.click(); 
        URL.revokeObjectURL(url);
        showAlert('バックアップを保存しました', 'success');
      });

      document.getElementById('restoreBtn').addEventListener('click', () => {
        document.getElementById('restoreFile').click();
      });

      document.getElementById('restoreFile').addEventListener('change', e => {
        const reader = new FileReader(); 
        reader.onload = ev => {
          try {
            JSON.parse(ev.target.result);
            localStorage.setItem(STORAGE_KEY, ev.target.result);
            displayEmpRecords(); 
            updateButtons(nameInput.value.trim());
            showAlert('データを復元しました', 'success');
          } catch {
            showAlert('無効なデータ形式です', 'error');
          }
        }; 
        reader.readAsText(e.target.files[0]);
      });

      document.getElementById('clearAllBtn').addEventListener('click', () => {
        const pwd = prompt('パスワードを入力してください:');
        if (pwd === '4564') {
          localStorage.removeItem(STORAGE_KEY);
          displayEmpRecords(); 
          updateButtons('');
          showAlert('全データを削除しました', 'success');
        } else if (pwd !== null) {
          showAlert('パスワードが違います', 'error');
        }
      });
      
      // 時計の初期化と更新
      updateClock();
      setInterval(updateClock, 1000); // 1秒ごとに更新
      
      displayEmpRecords(); 
      updateButtons('');
      
      // 初期状態のクリアボタン表示制御
      updateClearButton('empName', 'clearEmpNameBtn');
      updateClearButton('searchEmpName', 'clearSearchBtn');
    });
  </script>
</body>
</html>